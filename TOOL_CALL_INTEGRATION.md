# Phase 6: AI å·¥å…·è°ƒç”¨ç•Œé¢é›†æˆè¯´æ˜

## å·²å®Œæˆçš„å·¥ä½œ

### 1. æ–°å»ºç»„ä»¶: `components/ToolCallCard.tsx`

å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶ï¼Œç”¨äºåœ¨ ChatPanel ä¸­æ˜¾ç¤º MCP å·¥å…·è°ƒç”¨çš„è¿‡ç¨‹å’Œç»“æœã€‚

**ç»„ä»¶ Props:**
```typescript
interface ToolCallCardProps {
  toolCall: ToolCall;       // å·¥å…·è°ƒç”¨å¯¹è±¡
  isExpanded?: boolean;     // é»˜è®¤å±•å¼€çŠ¶æ€ (é»˜è®¤: false)
  language?: 'en' | 'zh';   // è¯­è¨€ (é»˜è®¤: 'en')
}
```

**ç»„ä»¶ç‰¹æ€§:**
- âœ… ç´§å‡‘å¸ƒå±€: é»˜è®¤æŠ˜å ,ç‚¹å‡»å±•å¼€
- âœ… çŠ¶æ€å¯è§†åŒ–: 4ç§çŠ¶æ€ (pending/running/success/error) ç”¨ä¸åŒé¢œè‰²å’Œå›¾æ ‡åŒºåˆ†
- âœ… åŠ è½½åŠ¨ç”»: æ‰§è¡Œä¸­æ˜¾ç¤ºæ—‹è½¬çš„ Loader å›¾æ ‡
- âœ… æ—¶é—´æ˜¾ç¤º: æ˜¾ç¤ºæ‰§è¡Œè€—æ—¶ (ç§’)
- âœ… ä»£ç æ ¼å¼åŒ–: å‚æ•°å’Œç»“æœä½¿ç”¨ `<pre>` æ ‡ç­¾,å¸¦æ»šåŠ¨æ¡
- âœ… é”™è¯¯é«˜äº®: é”™è¯¯ä¿¡æ¯ä½¿ç”¨çº¢è‰²èƒŒæ™¯é«˜äº®æ˜¾ç¤º
- âœ… å›½é™…åŒ–: æ”¯æŒè‹±æ–‡/ä¸­æ–‡åˆ‡æ¢

**çŠ¶æ€é¢œè‰²æ–¹æ¡ˆ:**
- `pending` (ç­‰å¾…ä¸­): é»„è‰²è¾¹æ¡† + é»„è‰²èƒŒæ™¯
- `running` (æ‰§è¡Œä¸­): è“è‰²è¾¹æ¡† + è“è‰²èƒŒæ™¯ + æ—‹è½¬åŠ¨ç”»
- `success` (æˆåŠŸ): ç»¿è‰²è¾¹æ¡† + ç»¿è‰²èƒŒæ™¯
- `error` (é”™è¯¯): çº¢è‰²è¾¹æ¡† + çº¢è‰²èƒŒæ™¯

### 2. ä¿®æ”¹: `components/ChatPanel.tsx`

åœ¨æ¶ˆæ¯æ¸²æŸ“é€»è¾‘ä¸­é›†æˆäº†å·¥å…·è°ƒç”¨æ˜¾ç¤º:

```tsx
{msg.toolCalls && msg.toolCalls.length > 0 && (
  <div className="space-y-2 mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-700">
    <div className="text-xs font-medium text-neutral-500 dark:text-neutral-400 mb-2">
      {language === 'zh' ? 'å·¥å…·è°ƒç”¨' : 'Tool Calls'} ({msg.toolCalls.length})
    </div>
    {msg.toolCalls.map(tc => (
      <ToolCallCard
        key={tc.id}
        toolCall={tc}
        language={language}
      />
    ))}
  </div>
)}
```

**é›†æˆä½ç½®:** åœ¨ Markdown å†…å®¹æ¸²æŸ“å,ä½œä¸ºæ¶ˆæ¯çš„é™„åŠ ä¿¡æ¯æ˜¾ç¤ºã€‚

### 3. ä¿®æ”¹: `utils/translations.ts`

æ·»åŠ äº†å·¥å…·è°ƒç”¨ç›¸å…³çš„ç¿»è¯‘é”®:

```typescript
toolCall: {
  title: 'Tool Calls' / 'å·¥å…·è°ƒç”¨',
  arguments: 'Arguments' / 'å‚æ•°',
  result: 'Result' / 'ç»“æœ',
  pending: 'Pending' / 'ç­‰å¾…ä¸­',
  running: 'Running' / 'æ‰§è¡Œä¸­',
  success: 'Success' / 'æˆåŠŸ',
  error: 'Error' / 'é”™è¯¯',
  duration: 'Duration' / 'è€—æ—¶',
  errorMessage: 'Error Message' / 'é”™è¯¯ä¿¡æ¯',
}
```

## ä¸‹ä¸€æ­¥: åœ¨ App.tsx ä¸­é›†æˆå·¥å…·è°ƒç”¨è¿½è¸ª

### éœ€è¦ä¿®æ”¹çš„ä»£ç ä½ç½®

åœ¨ `App.tsx` çš„ `handleChatMessage` å‡½æ•°ä¸­,éœ€è¦åœ¨è°ƒç”¨ AI å·¥å…·æ—¶è®°å½•å·¥å…·è°ƒç”¨ä¿¡æ¯:

```typescript
const handleChatMessage = async (text: string) => {
  // ... ç°æœ‰ä»£ç  ...

  try {
    // åˆ›å»ºå·¥å…·è°ƒç”¨è¿½è¸ªæ•°ç»„
    const toolCalls: ToolCall[] = [];

    // ä¿®æ”¹ executeAiTool å‡½æ•°ä»¥è®°å½•å·¥å…·è°ƒç”¨
    const executeToolWithTracking = async (toolName: string, args: any) => {
      // 1. åˆ›å»ºå·¥å…·è°ƒç”¨è®°å½•
      const tc: ToolCall = {
        id: generateId(),
        name: toolName,
        args,
        status: 'running',
        startTime: Date.now()
      };
      toolCalls.push(tc);

      // 2. ç«‹å³æ›´æ–° UI æ˜¾ç¤ºæ­£åœ¨æ‰§è¡Œ
      setChatMessages(prev => prev.map(msg =>
        msg.id === aiMessageId
          ? { ...msg, toolCalls: [...toolCalls] }
          : msg
      ));

      try {
        // 3. æ‰§è¡ŒåŸæœ‰å·¥å…·é€»è¾‘
        const result = await executeAiTool(toolName, args);

        // 4. æ›´æ–°ä¸ºæˆåŠŸçŠ¶æ€
        tc.status = 'success';
        tc.result = result;
        tc.endTime = Date.now();

        // 5. æ›´æ–° UI
        setChatMessages(prev => prev.map(msg =>
          msg.id === aiMessageId
            ? { ...msg, toolCalls: [...toolCalls] }
            : msg
        ));

        return result;
      } catch (error: any) {
        // 6. æ›´æ–°ä¸ºé”™è¯¯çŠ¶æ€
        tc.status = 'error';
        tc.error = error.message || String(error);
        tc.endTime = Date.now();

        // 7. æ›´æ–° UI
        setChatMessages(prev => prev.map(msg =>
          msg.id === aiMessageId
            ? { ...msg, toolCalls: [...toolCalls] }
            : msg
        ));

        throw error;
      }
    };

    // éæµå¼æ¨¡å¼ - ä½¿ç”¨è¿½è¸ªç‰ˆæœ¬çš„å·¥å…·æ‰§è¡Œ
    const response = await generateAIResponse(
      text,
      aiConfig,
      systemPrompt,
      false,
      [],
      executeToolWithTracking, // ä½¿ç”¨è¿½è¸ªç‰ˆæœ¬
      undefined,
      historyForAI
    );

    // ... å…¶ä½™ä»£ç  ...
  } catch (err: any) {
    // ... é”™è¯¯å¤„ç† ...
  }
};
```

### å®ç°è¦ç‚¹

1. **å·¥å…·è°ƒç”¨æ•°ç»„**: åœ¨æ¶ˆæ¯å¤„ç†å¼€å§‹æ—¶åˆ›å»º `toolCalls: ToolCall[]` æ•°ç»„
2. **åŒ…è£…å·¥å…·æ‰§è¡Œ**: åˆ›å»º `executeToolWithTracking` å‡½æ•°åŒ…è£…åŸæœ‰çš„ `executeAiTool`
3. **å®æ—¶æ›´æ–° UI**: æ¯æ¬¡çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°æ¶ˆæ¯çš„ `toolCalls` å­—æ®µ
4. **çŠ¶æ€æµè½¬**: pending â†’ running â†’ success/error
5. **æ—¶é—´è®°å½•**: è®°å½• `startTime` å’Œ `endTime` ç”¨äºè®¡ç®—è€—æ—¶

### ç°æœ‰å·¥å…·ç±»å‹ (types.ts)

```typescript
export interface ToolCall {
  id: string;                    // å”¯ä¸€æ ‡è¯†
  name: string;                  // å·¥å…·åç§°
  args: Record<string, any>;     // å·¥å…·å‚æ•°
  result?: any;                  // æ‰§è¡Œç»“æœ
  status: 'pending' | 'running' | 'success' | 'error';
  error?: string;                // é”™è¯¯ä¿¡æ¯
  startTime?: number;            // å¼€å§‹æ—¶é—´ (timestamp)
  endTime?: number;              // ç»“æŸæ—¶é—´ (timestamp)
}
```

### æµå¼æ¨¡å¼æ”¯æŒ

å¯¹äºæµå¼å“åº” (`enableStreaming: true`),å·¥å…·è°ƒç”¨è¿½è¸ªæš‚ä¸æ”¯æŒ,å› ä¸ºæµå¼æ¨¡å¼é€šå¸¸ä¸åŒ…å«å·¥å…·è°ƒç”¨ã€‚å¦‚æœæœªæ¥éœ€è¦æ”¯æŒæµå¼+å·¥å…·è°ƒç”¨çš„æ··åˆæ¨¡å¼,éœ€è¦:

1. ä¿®æ”¹ `generateAIResponseStream` ä»¥æ”¯æŒå·¥å…·è°ƒç”¨
2. åœ¨æµå¼è¾“å‡ºä¸­æ£€æµ‹å·¥å…·è°ƒç”¨äº‹ä»¶
3. ä½¿ç”¨ç±»ä¼¼çš„è¿½è¸ªé€»è¾‘æ›´æ–° UI

## UI æ•ˆæœé¢„è§ˆ

### æŠ˜å çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ search_knowledge_base âœ“ æˆåŠŸ 0.52s â”‚
â”‚                                    âŒ„   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å±•å¼€çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ search_knowledge_base âœ“ æˆåŠŸ 0.52s â”‚
â”‚                                    âŒƒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‚æ•°                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ {                                â”‚  â”‚
â”‚ â”‚   "query": "RAG integration",    â”‚  â”‚
â”‚ â”‚   "limit": 5                     â”‚  â”‚
â”‚ â”‚ }                                â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚
â”‚ ç»“æœ                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Found 3 relevant chunks...       â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”™è¯¯çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ invalid_tool âœ— é”™è¯¯            1.2s â”‚
â”‚                                    âŒƒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‚æ•°                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ { ... }                          â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚
â”‚ é”™è¯¯ä¿¡æ¯                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Tool not found: invalid_tool     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•å»ºè®®

### 1. åˆ›å»ºæµ‹è¯•æ•°æ®

åœ¨ ChatPanel ä¸­æ‰‹åŠ¨æ·»åŠ æµ‹è¯•æ¶ˆæ¯:

```typescript
const testMessage: ChatMessage = {
  id: 'test-1',
  role: 'assistant',
  content: 'I searched your knowledge base for relevant information.',
  timestamp: Date.now(),
  toolCalls: [
    {
      id: 'tc-1',
      name: 'search_knowledge_base',
      args: { query: 'RAG integration', limit: 5 },
      status: 'success',
      result: { chunks: 3, files: 2 },
      startTime: Date.now() - 520,
      endTime: Date.now()
    },
    {
      id: 'tc-2',
      name: 'edit_file',
      args: { filePath: 'test.md', content: '...' },
      status: 'running',
      startTime: Date.now()
    }
  ]
};
```

### 2. æµ‹è¯•åœºæ™¯

- [ ] æµ‹è¯•å•ä¸ªå·¥å…·è°ƒç”¨æ˜¾ç¤º
- [ ] æµ‹è¯•å¤šä¸ªå·¥å…·è°ƒç”¨ (æˆåŠŸ+å¤±è´¥æ··åˆ)
- [ ] æµ‹è¯•å±•å¼€/æŠ˜å äº¤äº’
- [ ] æµ‹è¯•é•¿å‚æ•°/ç»“æœçš„æ»šåŠ¨
- [ ] æµ‹è¯•æš—è‰²/äº®è‰²ä¸»é¢˜é€‚é…
- [ ] æµ‹è¯•ä¸­è‹±æ–‡åˆ‡æ¢
- [ ] æµ‹è¯•æ‰§è¡Œä¸­çš„åŠ¨ç”»æ•ˆæœ

### 3. æ€§èƒ½æµ‹è¯•

- [ ] æµ‹è¯•å¤§é‡å·¥å…·è°ƒç”¨ (10+) çš„æ€§èƒ½
- [ ] æµ‹è¯•å¤§å‹ç»“æœå¯¹è±¡ (å¦‚æ–‡ä»¶å†…å®¹) çš„æ¸²æŸ“

## æ„å»ºéªŒè¯

âœ… TypeScript ç¼–è¯‘é€šè¿‡
âœ… Vite æ„å»ºæˆåŠŸ
âœ… æ— ç±»å‹é”™è¯¯
âœ… ç»„ä»¶æ­£ç¡®å¯¼å…¥

```bash
npm run build
# âœ… Build completed successfully
```

## ç›¸å…³æ–‡ä»¶

- âœ… `components/ToolCallCard.tsx` - å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶
- âœ… `components/ChatPanel.tsx` - é›†æˆå·¥å…·è°ƒç”¨æ˜¾ç¤º
- âœ… `utils/translations.ts` - æ·»åŠ å›½é™…åŒ–ç¿»è¯‘
- âœ… `types.ts` - ToolCall æ¥å£ (å·²å­˜åœ¨,æ— éœ€ä¿®æ”¹)
- â³ `App.tsx` - éœ€è¦é›†æˆå·¥å…·è°ƒç”¨è¿½è¸ªé€»è¾‘
- â³ `services/aiService.ts` - å¯èƒ½éœ€è¦ä¿®æ”¹ä»¥æ”¯æŒå·¥å…·è°ƒç”¨å›è°ƒ

## æ€»ç»“

Phase 6 çš„ UI éƒ¨åˆ†å·²ç»å®Œæˆ,å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶å¯ä»¥æ­£ç¡®æ˜¾ç¤ºå·¥å…·è°ƒç”¨çš„çŠ¶æ€ã€å‚æ•°ã€ç»“æœå’Œé”™è¯¯ä¿¡æ¯ã€‚ä¸‹ä¸€æ­¥éœ€è¦åœ¨ `App.tsx` ä¸­å®ç°å·¥å…·è°ƒç”¨è¿½è¸ªé€»è¾‘,åœ¨ AI è°ƒç”¨å·¥å…·æ—¶è®°å½•å’Œæ›´æ–°å·¥å…·è°ƒç”¨çŠ¶æ€,ä»¥ä¾¿åœ¨ UI ä¸­å®æ—¶æ˜¾ç¤ºã€‚
