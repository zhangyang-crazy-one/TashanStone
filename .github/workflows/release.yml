# Release Workflow
# Triggered by pushing a tag like v1.7.0
# Builds and publishes installers for all platforms

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  NODE_VERSION: '20'

jobs:
  # Job 1: Create Release Draft
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: TashanStone ${{ github.ref_name }}
          draft: true
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true

  # Job 2: Build Windows Installer
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: create-release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and Package
        run: npm run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            release/*.exe
            release/*.exe.blockmap

  # Job 3: Build macOS Installer (暂时跳过，缺少代码签名证书)
  # build-macos:
  #   name: Build macOS
  #   runs-on: macos-latest
  #   needs: create-release
  #   strategy:
  #     matrix:
  #       arch: [x64, arm64]
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Build and Package
  #       run: npm run dist:mac -- --${{ matrix.arch }}
  #       env:
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         # macOS code signing (optional)
  #         CSC_LINK: ${{ secrets.MAC_CERTS }}
  #         CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
  #         APPLE_ID: ${{ secrets.APPLE_ID }}
  #         APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
  #         APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

  #     - name: Upload macOS artifacts
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         tag_name: ${{ github.ref_name }}
  #         draft: true
  #         files: |
  #           release/*.dmg
  #           release/*.zip

  # Job 4: Build Linux Packages
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev librsvg2-dev libasound2-dev rpm

      - name: Install dependencies
        run: npm ci

      - name: Build and Package
        run: npm run dist:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            release/*.deb
            release/*.tar.gz
            release/*.AppImage

  # Job 5: Publish Release
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const releases = await github.rest.repos.listReleases({ owner, repo });
            const draft = releases.data.find(r => r.draft && r.tag_name === context.ref.replace('refs/tags/', ''));
            if (draft) {
              await github.rest.repos.updateRelease({
                owner,
                repo,
                release_id: draft.id,
                draft: false
              });
              console.log(`Published release: ${draft.name}`);
            }
