# V1.75 ä¼˜åŒ–æŒ‡å—

> åˆ›å»ºæ—¥æœŸï¼š2026-01-01
> ä»£ç å®¡æŸ¥è¯„åˆ†ï¼š98/100 (ä¼˜ç§€)
> çŠ¶æ€ï¼šå¾…ä¼˜åŒ–

---

## å®¡æŸ¥æ€»ç»“

V1.75 å·²é€šè¿‡ä»£ç å®¡æŸ¥ï¼Œæ•´ä½“è´¨é‡ä¼˜ç§€ï¼š

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| æµ‹è¯•è¦†ç›– | 108 tests, 100% é€šè¿‡ |
| åŠŸèƒ½å®Œæˆåº¦ | 100% (53/53 ä»»åŠ¡) |
| ä»£ç è´¨é‡è¯„åˆ† | 98/100 |
| æ¨èçŠ¶æ€ | âœ… æ‰¹å‡†å‘å¸ƒ |

---

## ä¼˜åŒ–é¡¹æ¦‚è§ˆ

| ä¼˜å…ˆçº§ | é—®é¢˜ | ä½ç½® | å·¥æ—¶ |
|--------|------|------|------|
| ğŸ”´ é«˜ | XSS é¢„é˜² | `WikiLink.tsx:107` | 1h |
| ğŸŸ  ä¸­ | çŸ¥è¯†å›¾è°±ç´¢å¼•æ€§èƒ½ | `wikiLinkService.ts:140` | 2-3h |
| ğŸŸ  ä¸­ | æœç´¢æ€§èƒ½ä¼˜åŒ– | `searchService.ts:99` | 3-4h |
| ğŸŸ¢ ä½ | é¢˜åº“ç»Ÿè®¡ç¼“å­˜ | `questionBankService.ts` | 1-2h |
| ğŸŸ¢ ä½ | æ·»åŠ ç»„ä»¶æµ‹è¯• | `test/components/` | 4-6h |

**æ€»è®¡å·¥æ—¶**: 10-15h

---

## ä¼˜åŒ–é¡¹ 1: XSS é¢„é˜² (å®‰å…¨ä¼˜å…ˆ)

### é—®é¢˜æè¿°

**æ–‡ä»¶**: `components/WikiLink.tsx`
**ä½ç½®**: è¡Œ 107
**é£é™©ç­‰çº§**: ğŸ”´ é«˜

WikiLink æ‚¬åœé¢„è§ˆç›´æ¥æ¸²æŸ“æ–‡ä»¶å†…å®¹ï¼Œå¯èƒ½å¯¼è‡´ XSS æ”»å‡»ã€‚

### å½“å‰å®ç°

```tsx
// components/WikiLink.tsx:107
<div className="text-[10px] text-gray-500 dark:text-gray-400 line-clamp-6 leading-relaxed">
  {targetFile.content.slice(0, 300)}...
</div>
```

### é£é™©åœºæ™¯

å¦‚æœ Markdown æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
```markdown
<script>alert('XSS')</script>
```

React ä¼šé˜»æ­¢ç›´æ¥æ³¨å…¥ï¼Œä½†æŸäº›æƒ…å†µä¸‹ï¼ˆå¦‚ä½¿ç”¨ `dangerouslySetInnerHTML`ï¼‰å¯èƒ½å­˜åœ¨é£é™©ã€‚

### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ A: è½¬ä¹‰ HTML å­—ç¬¦ (æ¨è)**

```tsx
// utils/escapeHtml.ts
export const escapeHtml = (text: string): string => {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
};

// components/WikiLink.tsx
import { escapeHtml } from '../utils/escapeHtml';

<div className="text-[10px] ...">
  {escapeHtml(targetFile.content.slice(0, 300))}...
</div>
```

**æ–¹æ¡ˆ B: ä½¿ç”¨ DOMPurify åº“**

```bash
npm install dompurify
npm install --save-dev @types/dompurify
```

```tsx
import DOMPurify from 'dompurify';

const safeContent = DOMPurify.sanitize(targetFile.content.slice(0, 300), {
  ALLOWED_TAGS: []  // ä¸å…è®¸ä»»ä½• HTML æ ‡ç­¾
});
```

---

## ä¼˜åŒ–é¡¹ 2: çŸ¥è¯†å›¾è°±ç´¢å¼•æ€§èƒ½

### é—®é¢˜æè¿°

**æ–‡ä»¶**: `src/services/wiki/wikiLinkService.ts`
**ä½ç½®**: `generateFileLinkGraph` å‡½æ•° (è¡Œ 140-196)
**å½±å“**: å¤§å‹ç¬”è®°åº“åŠ è½½ç¼“æ…¢

### å½“å‰å®ç°é—®é¢˜

```typescript
// ç¬¬ä¸€æ¬¡éå†: æå– WikiLinks (è¡Œ 158-173)
files.forEach(source => {
  const extracted = extractWikiLinks(source.content);
  extracted.forEach(link => {
    // ...
  });
});

// ç¬¬äºŒæ¬¡éå†: æå– Tags (è¡Œ 182-193)
files.forEach(f => {
  const tags = extractTags(f.content);
  // ...
});
```

**é—®é¢˜**: å¯¹åŒä¸€æ‰¹æ–‡ä»¶è¿›è¡Œä¸¤æ¬¡å®Œæ•´éå†ï¼Œä¸”æ¯æ¬¡éƒ½è°ƒç”¨æ­£åˆ™è§£æã€‚

### ä¼˜åŒ–æ–¹æ¡ˆ

```typescript
export const generateFileLinkGraph = (files: MarkdownFile[], index: KnowledgeIndex) => {
  // é¢„è®¡ç®—: ä¸€æ¬¡éå†æå–æ‰€æœ‰æ•°æ®
  const fileData = new Map<string, {
    links: WikiLink[];
    tags: string[]
  }>();

  files.forEach(f => {
    fileData.set(f.id, {
      links: extractWikiLinks(f.content),
      tags: extractTags(f.content)
    });
  });

  const nodes = files.map(f => ({
    id: f.id,
    label: f.name,
    group: 1,
    val: 1,
    type: 'file' as const
  }));

  const links: { source: string; target: string; relationship: string }[] = [];
  const nameMap = new Map<string, string>();

  files.forEach(f => {
    nameMap.set(f.name.toLowerCase(), f.id);
  });

  // ä½¿ç”¨é¢„è®¡ç®—æ•°æ®æ„å»ºé“¾æ¥
  files.forEach(source => {
    const { links: extracted } = fileData.get(source.id)!;
    extracted.forEach(link => {
      const targetId = nameMap.get(link.target.toLowerCase());
      if (targetId && targetId !== source.id) {
        const exists = links.some(l => l.source === source.id && l.target === targetId);
        if (!exists) {
          links.push({
            source: source.id,
            target: targetId,
            relationship: 'wikilink'
          });
        }
      }
    });
  });

  // æ›´æ–°èŠ‚ç‚¹æƒé‡
  links.forEach(l => {
    const sourceNode = nodes.find(n => n.id === l.source);
    const targetNode = nodes.find(n => n.id === l.target);
    if (sourceNode) sourceNode.val = (sourceNode.val || 1) + 1;
    if (targetNode) targetNode.val = (targetNode.val || 1) + 1;
  });

  // ä½¿ç”¨é¢„è®¡ç®—æ ‡ç­¾è®¾ç½®åˆ†ç»„
  files.forEach(f => {
    const { tags } = fileData.get(f.id)!;
    const node = nodes.find(n => n.id === f.id);
    if (node && tags.length > 0) {
      let hash = 0;
      const str = tags[0];
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      node.group = Math.abs(hash) % 10 + 2;
    }
  });

  return { nodes, links };
};
```

### é¢„æœŸæ”¶ç›Š

| æ–‡ä»¶æ•°é‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|---------|--------|--------|------|
| 50 | 120ms | 70ms | 42% |
| 100 | 280ms | 140ms | 50% |
| 200 | 650ms | 270ms | 58% |

---

## ä¼˜åŒ–é¡¹ 3: æœç´¢æ€§èƒ½ä¼˜åŒ–

### é—®é¢˜æè¿°

**æ–‡ä»¶**: `src/services/search/searchService.ts`
**ä½ç½®**: `instantSearch` å‡½æ•° (è¡Œ 99-178)
**å½±å“**: æœç´¢å“åº”å»¶è¿Ÿ

### å½“å‰å®ç°é—®é¢˜

```typescript
// è¡Œ 117: æ— æŸ¥è¯¢æ—¶ä¹Ÿæå–æ ‡ç­¾
return filteredFiles.slice(0, maxResults).map(file => ({
  // ...
  tags: extractTags(file.content)  // æ¯ä¸ªæ–‡ä»¶éƒ½è°ƒç”¨
}));

// è¡Œ 153: æœ‰æŸ¥è¯¢æ—¶å†æ¬¡æå–
const tags = extractTags(file.content);
```

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ A: æ ‡ç­¾ç¼“å­˜**

```typescript
// åœ¨ MarkdownFile ç±»å‹ä¸­æ·»åŠ å¯é€‰ç¼“å­˜å­—æ®µ
interface CachedMarkdownFile extends MarkdownFile {
  _cachedTags?: string[];
  _tagsCacheTime?: number;
}

const CACHE_TTL = 60000; // 60ç§’ç¼“å­˜

const getCachedTags = (file: CachedMarkdownFile): string[] => {
  const now = Date.now();
  if (file._cachedTags && file._tagsCacheTime && (now - file._tagsCacheTime < CACHE_TTL)) {
    return file._cachedTags;
  }

  file._cachedTags = extractTags(file.content);
  file._tagsCacheTime = now;
  return file._cachedTags;
};
```

**æ–¹æ¡ˆ B: æƒ°æ€§è®¡ç®—**

```typescript
export const instantSearch = (
  files: MarkdownFile[],
  query: string,
  options?: Partial<SearchOptions>
): SearchResult[] => {
  const { plainQuery, filter } = parseSearchQuery(query);
  const maxResults = options?.maxResults || 20;
  const includeTags = options?.includeTags !== false; // é»˜è®¤åŒ…å«

  let filteredFiles = filterFiles(files, filter);

  if (!plainQuery.trim()) {
    return filteredFiles.slice(0, maxResults).map(file => ({
      fileId: file.id,
      fileName: file.name,
      path: file.path || file.name,
      score: 1,
      matches: [],
      lastModified: file.lastModified,
      // ä»…åœ¨éœ€è¦æ—¶æå–æ ‡ç­¾
      tags: includeTags ? getCachedTags(file) : []
    }));
  }

  // ... å…¶ä½™é€»è¾‘
};
```

### é¢„æœŸæ”¶ç›Š

æœç´¢å“åº”æ—¶é—´å‡å°‘ 30-50%ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§å‹ç¬”è®°åº“ä¸­æ•ˆæœæ˜æ˜¾ã€‚

---

## ä¼˜åŒ–é¡¹ 4: é¢˜åº“ç»Ÿè®¡ç¼“å­˜

### é—®é¢˜æè¿°

**æ–‡ä»¶**: `src/services/quiz/questionBankService.ts`
**ä½ç½®**: `getBankStats` æ–¹æ³• (è¡Œ 170-201)
**å½±å“**: é¢‘ç¹è°ƒç”¨æ—¶æ€§èƒ½ä¸‹é™

### å½“å‰å®ç°

```typescript
getBankStats(bankId: string): QuestionBankStats | null {
  const bank = this.banks.find(b => b.id === bankId);
  if (!bank) return null;

  // æ¯æ¬¡è°ƒç”¨éƒ½éå†æ‰€æœ‰é¢˜ç›®
  const totalQuestions = bank.questions.length;
  const byDifficulty: Record<string, number> = {};
  // ...
}
```

### ä¼˜åŒ–æ–¹æ¡ˆ

```typescript
export class QuestionBankService {
  private banks: QuestionBank[] = [];
  private initialized: boolean = false;

  // æ–°å¢: ç»Ÿè®¡ç¼“å­˜
  private statsCache: Map<string, {
    stats: QuestionBankStats;
    timestamp: number
  }> = new Map();
  private readonly CACHE_TTL = 5000; // 5ç§’ç¼“å­˜

  getBankStats(bankId: string): QuestionBankStats | null {
    // æ£€æŸ¥ç¼“å­˜
    const cached = this.statsCache.get(bankId);
    if (cached && Date.now() - cached.timestamp < this.CACHE_TTL) {
      return cached.stats;
    }

    const bank = this.banks.find(b => b.id === bankId);
    if (!bank) return null;

    // è®¡ç®—ç»Ÿè®¡
    const stats = this.calculateStats(bank);

    // å­˜å…¥ç¼“å­˜
    this.statsCache.set(bankId, {
      stats,
      timestamp: Date.now()
    });

    return stats;
  }

  private calculateStats(bank: QuestionBank): QuestionBankStats {
    const totalQuestions = bank.questions.length;
    const byDifficulty: Record<string, number> = {};
    const byTags: Record<string, number> = {};
    let totalSuccessRate = 0;
    let questionsWithStats = 0;

    bank.questions.forEach(q => {
      if (q.difficulty) {
        byDifficulty[q.difficulty] = (byDifficulty[q.difficulty] || 0) + 1;
      }
      if (q.tags) {
        q.tags.forEach(tag => {
          byTags[tag] = (byTags[tag] || 0) + 1;
        });
      }
      if (q.successRate !== undefined) {
        totalSuccessRate += q.successRate;
        questionsWithStats++;
      }
    });

    return {
      totalQuestions,
      byDifficulty,
      byTags,
      averageSuccessRate: questionsWithStats > 0
        ? Math.round(totalSuccessRate / questionsWithStats)
        : 0
    };
  }

  // åœ¨ä¿®æ”¹æ“ä½œä¸­æ¸…é™¤ç¼“å­˜
  private invalidateCache(bankId: string): void {
    this.statsCache.delete(bankId);
  }

  async addQuestionsToBank(bankId: string, questions: QuizQuestion[]): Promise<boolean> {
    // ... ç°æœ‰é€»è¾‘
    this.invalidateCache(bankId);  // æ·»åŠ è¿™è¡Œ
    return true;
  }

  async removeQuestion(bankId: string, questionId: string): Promise<boolean> {
    // ... ç°æœ‰é€»è¾‘
    this.invalidateCache(bankId);  // æ·»åŠ è¿™è¡Œ
    return true;
  }
}
```

---

## ä¼˜åŒ–é¡¹ 5: æ·»åŠ ç»„ä»¶æµ‹è¯•

### å»ºè®®æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶ | æµ‹è¯•å†…å®¹ |
|------|---------|
| `test/components/WikiLink.test.tsx` | é“¾æ¥æ¸²æŸ“ã€æ‚¬åœé¢„è§ˆã€å¯¼èˆª |
| `test/components/BacklinkPanel.test.tsx` | åå‘é“¾æ¥æ˜¾ç¤ºã€ç‚¹å‡»å¯¼èˆª |
| `test/components/SearchModal.test.tsx` | æœç´¢è¿‡æ»¤ã€ç»“æœå±•ç¤ºã€é”®ç›˜å¯¼èˆª |
| `test/components/TagsBrowser.test.tsx` | æ ‡ç­¾æ ‘ã€æœç´¢ã€æ‰¹é‡æ“ä½œ |
| `test/components/StudyPlanPanel.test.tsx` | è®¡åˆ’å±•ç¤ºã€ä»»åŠ¡å®Œæˆã€è¿‡æœŸå¤„ç† |

### æµ‹è¯•æ¡†æ¶é…ç½®

```bash
npm install --save-dev @testing-library/react @testing-library/jest-dom @testing-library/user-event
```

### WikiLink.test.tsx ç¤ºä¾‹

```tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { WikiLink } from '../../components/WikiLink';
import { MarkdownFile } from '../../types';

const mockFiles: MarkdownFile[] = [
  { id: '1', name: 'TestPage', content: 'Test content here', lastModified: Date.now() }
];

describe('WikiLink', () => {
  it('renders link with correct text', () => {
    render(
      <WikiLink
        href="?wiki=TestPage"
        files={mockFiles}
        onNavigate={() => {}}
      >
        TestPage
      </WikiLink>
    );

    expect(screen.getByText('[[TestPage]]')).toBeInTheDocument();
  });

  it('shows preview on hover after delay', async () => {
    render(
      <WikiLink
        href="?wiki=TestPage"
        files={mockFiles}
        onNavigate={() => {}}
      >
        TestPage
      </WikiLink>
    );

    fireEvent.mouseEnter(screen.getByText('[[TestPage]]'));

    await waitFor(() => {
      expect(screen.getByText(/Test content/)).toBeInTheDocument();
    }, { timeout: 600 });
  });

  it('calls onNavigate when clicked', () => {
    const onNavigate = vi.fn();

    render(
      <WikiLink
        href="?wiki=TestPage"
        files={mockFiles}
        onNavigate={onNavigate}
      >
        TestPage
      </WikiLink>
    );

    fireEvent.click(screen.getByText('[[TestPage]]'));

    expect(onNavigate).toHaveBeenCalledWith('1');
  });

  it('shows non-existent link style when target not found', () => {
    render(
      <WikiLink
        href="?wiki=NonExistent"
        files={mockFiles}
        onNavigate={() => {}}
      >
        NonExistent
      </WikiLink>
    );

    const link = screen.getByText('[[NonExistent]]').closest('a');
    expect(link).toHaveClass('text-slate-400');
  });
});
```

---

## å®æ–½ä¼˜å…ˆçº§

| é¡ºåº | ä¼˜åŒ–é¡¹ | å·¥æ—¶ | ç†ç”± |
|------|--------|------|------|
| 1 | XSS é¢„é˜² | 1h | ğŸ”´ å®‰å…¨é—®é¢˜ä¼˜å…ˆ |
| 2 | çŸ¥è¯†å›¾è°±ç´¢å¼•æ€§èƒ½ | 2-3h | ç”¨æˆ·ä½“éªŒå½±å“å¤§ |
| 3 | æœç´¢æ€§èƒ½ä¼˜åŒ– | 3-4h | é«˜é¢‘ä½¿ç”¨åŠŸèƒ½ |
| 4 | é¢˜åº“ç»Ÿè®¡ç¼“å­˜ | 1-2h | æ”¹åŠ¨å°ï¼Œæ”¶ç›Šæ˜ç¡® |
| 5 | ç»„ä»¶æµ‹è¯• | 4-6h | é•¿æœŸç»´æŠ¤ä»·å€¼ |

---

## ç›¸å…³æ–‡æ¡£

- é¡¹ç›®æ¦‚è§ˆï¼š[PROJECT.md](./PROJECT.md)
- é¡¹ç›®çŠ¶æ€ï¼š[PROJECT_STATUS.md](./PROJECT_STATUS.md)
- å¾…åŠäº‹é¡¹ï¼š[TODO.md](./TODO.md)
- V1.75 éªŒè¯æŠ¥å‘Šï¼š[V1.75_VERIFICATION.md](./V1.75_VERIFICATION.md)
