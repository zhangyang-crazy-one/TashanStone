# V1.75 åŠŸèƒ½é›†æˆè®¡åˆ’ï¼ˆä¿®è®¢ç‰ˆï¼‰

> ç‰ˆæœ¬ï¼šv1.75
> åˆ›å»ºæ—¥æœŸï¼š2025-12-31
> åŸºäºï¼šzhang_reader/New_Features/zhangnote é¡¹ç›®åˆ†æ
> ä¿®è®¢ï¼š2025-12-31 - æ·»åŠ é—æ¼çš„æ ¸å¿ƒåŠŸèƒ½

---

## âš ï¸ é‡è¦æ›´æ­£

### åŸè®¡åˆ’é—æ¼çš„æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | é‡è¦æ€§ | çŠ¶æ€ |
|------|--------|------|
| è¯•é¢˜åº“ï¼ˆQuiz Bankï¼‰ | ğŸ”´ æ ¸å¿ƒ | âŒ é—æ¼ |
| åŒå‘é“¾æ¥ç³»ç»Ÿ | ğŸ”´ æ ¸å¿ƒ | âŒ é—æ¼ |
| é¡µé¢çº§é“¾æ¥ `[[é¡µé¢æ ‡é¢˜]]` | ğŸ”´ æ ¸å¿ƒ | âŒ é—æ¼ |
| å—çº§å¼•ç”¨ `<<é¡µé¢æ ‡é¢˜ï¼šè¡Œå·>>` | ğŸ”´ æ ¸å¿ƒ | âŒ é—æ¼ |
| åå‘é“¾æ¥æ˜¾ç¤º | ğŸŸ  é«˜ | âŒ é—æ¼ |
| é“¾æ¥é¢„è§ˆï¼ˆæ‚¬åœï¼‰ | ğŸŸ  é«˜ | âŒ é—æ¼ |
| æ™ºèƒ½æ ‡ç­¾ç³»ç»Ÿ | ğŸŸ  é«˜ | âŒ é—æ¼ |
| è‡ªå®šä¹‰è§†å›¾ | ğŸŸ¡ ä¸­ | âŒ é—æ¼ |

---

## ğŸ“‹ zhangnote æ ¸å¿ƒåŠŸèƒ½åˆ†æ

### 1. åŒå‘é“¾æ¥ç³»ç»Ÿ

#### 1.1 WikiLink æ ¼å¼

**æ–‡ä»¶**ï¼š`zhangnote/components/WikiLink.tsx`

```typescript
// æ”¯æŒçš„é“¾æ¥æ ¼å¼
export const extractLinks = (content: string): { target: string, alias?: string }[] => {
  const regex = /\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g;
  // [[PageName]] - æ ‡å‡†é“¾æ¥
  // [[PageName|Alias]] - å¸¦åˆ«åé“¾æ¥
  // [[Exam:QuizName]] - è¯•é¢˜é“¾æ¥
  // [[Question:QuestionID]] - é—®é¢˜é“¾æ¥
};
```

#### 1.2 å—çº§å¼•ç”¨æ ¼å¼

**æ ¼å¼**ï¼š`<<é¡µé¢æ ‡é¢˜ï¼šè¡Œå·>>`

ç”¨äºç²¾ç¡®å¼•ç”¨ç‰¹å®šæ®µè½æˆ–å¥å­ã€‚

#### 1.3 åå‘é“¾æ¥

**åŠŸèƒ½**ï¼šè‡ªåŠ¨æ˜¾ç¤ºæ‰€æœ‰å¼•ç”¨å½“å‰ç¬”è®°çš„é¡µé¢ã€‚

---

### 2. æ ‡ç­¾ç³»ç»Ÿ

**æ–‡ä»¶**ï¼š`zhangnote/services/knowledgeService.ts`

```typescript
export const extractTags = (content: string): string[] => {
  const regex = /(?:^|\s)(#[a-zA-Z_\u4e00-\u9fa5][\w\-\/\u4e00-\u9fa5]*)/g;
  // æ”¯æŒ #tag å’Œ #nested/tag æ ¼å¼
  // æ”¯æŒä¸­æ–‡æ ‡ç­¾
};

export interface KnowledgeIndex {
  backlinks: Map<string, string[]>;  // é“¾æ¥å…³ç³»
  tags: Map<string, string[]>;        // æ ‡ç­¾ç´¢å¼•: tagName -> fileIds
}
```

---

### 3. è¯•é¢˜ç³»ç»Ÿ

**æ–‡ä»¶**ï¼š`zhangnote/services/aiService.ts`

| åŠŸèƒ½ | å‡½æ•° | è¯´æ˜ |
|------|------|------|
| ç”Ÿæˆè¯•é¢˜ | `generateQuiz()` | ä»å†…å®¹ç”Ÿæˆå¤šç§é¢˜å‹ |
| ç»“æ„åŒ–è€ƒè¯• | `generateStructuredExam()` | æŒ‰ä¸»é¢˜å’Œéš¾åº¦ç”Ÿæˆè€ƒè¯• |
| AI è¯„åˆ† | `gradeSubjectiveAnswer()` | ä¸»è§‚é¢˜æ™ºèƒ½è¯„åˆ† |
| è¯•é¢˜è§£æ | `extractQuizFromRawContent()` | ä»åŸå§‹å†…å®¹æå–è¯•é¢˜ |

**ç±»å‹å®šä¹‰**ï¼š`zhangnote/types.ts`

```typescript
export interface QuizQuestion {
  id: string;
  type: QuestionType;
  question: string;
  options?: string[];
  correctAnswer?: string | string[];
  explanation?: string;
  difficulty?: DifficultyLevel;
  tags?: string[];
  knowledgePoints?: string[];
  sourceFileId?: string;
}

export interface Quiz {
  id: string;
  title: string;
  description: string;
  questions: QuizQuestion[];
  isGraded: boolean;
  score?: number;
  config?: ExamConfig;
  status?: 'not_started' | 'in_progress' | 'completed';
}
```

---

### 4. æ™ºèƒ½åˆ†ç±»

**æ–‡ä»¶**ï¼š`zhangnote/services/aiService.ts`

| åŠŸèƒ½ | å‡½æ•° | è¯´æ˜ |
|------|------|------|
| é‡è¦æ€§è¯„åˆ† | `assessImportance()` | AI è¯„ä¼° 1-10 åˆ† |
| æ™ºèƒ½æ ‡ç­¾ | `suggestTags()` | AI å»ºè®®å±‚æ¬¡åŒ–æ ‡ç­¾ |
| åˆ†ç±»å»ºè®® | `suggestCategory()` | AI å»ºè®®æ–‡ä»¶å¤¹è·¯å¾„ |
| å…³è”å‘ç° | `findRelatedFiles()` | æŸ¥æ‰¾ç›¸å…³ç¬”è®° |

---

## ğŸ¯ é›†æˆç›®æ ‡

### æ ¸å¿ƒç›®æ ‡ï¼ˆP0ï¼‰

| # | åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|---|------|--------|------|
| 1 | **é¡µé¢çº§åŒå‘é“¾æ¥** `[[é¡µé¢æ ‡é¢˜]]` | P0 | æ”¯æŒ WikiLink æ ¼å¼ |
| 2 | **å—çº§å¼•ç”¨** `<<é¡µé¢ï¼šè¡Œå·>>` | P0 | ç²¾ç¡®å¼•ç”¨ç‰¹å®šæ®µè½ |
| 3 | **åå‘é“¾æ¥é¢æ¿** | P0 | æ˜¾ç¤ºå¼•ç”¨å½“å‰é¡µé¢çš„æ‰€æœ‰é¡µé¢ |
| 4 | **é“¾æ¥é¢„è§ˆ** | P0 | æ‚¬åœæ˜¾ç¤ºé“¾æ¥å†…å®¹ |
| 5 | **è¯•é¢˜åº“å¼ºåŒ–** | P0 | å®Œæ•´é¢˜åº“ç®¡ç†åŠŸèƒ½ |
| 6 | **æ™ºèƒ½æ ‡ç­¾ç³»ç»Ÿ** | P0 | AI å»ºè®® + æ‰‹åŠ¨ç®¡ç† |

### é«˜ä¼˜å…ˆçº§ç›®æ ‡ï¼ˆP1ï¼‰

| # | åŠŸèƒ½ | è¯´æ˜ |
|---|------|------|
| 1 | **è‡ªå®šä¹‰è§†å›¾** | æŒ‰æ ‡ç­¾ã€é“¾æ¥å…³ç³»ç­›é€‰ |
| 2 | **çŸ¥è¯†å›¾è°±å¢å¼º** | ä¸åŒå‘é“¾æ¥é›†æˆ |
| 3 | **æ ‡ç­¾ç´¢å¼•** | å¿«é€ŸæŒ‰æ ‡ç­¾æ£€ç´¢ |

---

## ğŸ”§ å®æ–½è®¡åˆ’

### Phase 1ï¼šåŒå‘é“¾æ¥ç³»ç»Ÿ

#### 1.1 WikiLink ç±»å‹å®šä¹‰

**æ–°å»ºæ–‡ä»¶**ï¼š`src/types/wiki.ts`

```typescript
export interface WikiLink {
  target: string;      // é“¾æ¥ç›®æ ‡é¡µé¢åç§°
  alias?: string;      // æ˜¾ç¤ºåˆ«å
  position: {
    start: number;     // åœ¨å†…å®¹ä¸­çš„èµ·å§‹ä½ç½®
    end: number;       // åœ¨å†…å®¹ä¸­çš„ç»“æŸä½ç½®
  };
}

export interface BlockReference {
  target: string;      // é¡µé¢åç§°
  lineNumber: number;  // è¡Œå·
  blockContent: string; // å¼•ç”¨çš„å†…å®¹ç‰‡æ®µ
  position: {
    start: number;
    end: number;
  };
}

export interface Backlink {
  sourceFileId: string;
  sourceFileName: string;
  linkType: 'wikilink' | 'blockref';
  context?: string;    // å¼•ç”¨ä¸Šä¸‹æ–‡
}

export interface PageLinks {
  fileId: string;
  fileName: string;
  outgoingLinks: WikiLink[];
  blockReferences: BlockReference[];
  backlinks: Backlink[];
}
```

#### 1.2 é“¾æ¥æå–æœåŠ¡

**æ–°å»ºæ–‡ä»¶**ï¼š`src/services/wiki/wikiLinkService.ts`

```typescript
import { WikiLink, BlockReference } from '../../types/wiki';

export const extractWikiLinks = (content: string): WikiLink[] => {
  const regex = /\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g;
  const links: WikiLink[] = [];
  let match;
  
  while ((match = regex.exec(content)) !== null) {
    links.push({
      target: match[1].trim(),
      alias: match[2]?.trim(),
      position: {
        start: match.index,
        end: match.index + match[0].length
      }
    });
  }
  
  return links;
};

export const extractBlockReferences = (content: string): BlockReference[] => {
  const regex = /<<([^:]+):(\d+)>>/g;
  const refs: BlockReference[] = [];
  let match;
  
  while ((match = regex.exec(content)) !== null) {
    refs.push({
      target: match[1].trim(),
      lineNumber: parseInt(match[2], 10),
      blockContent: '',
      position: {
        start: match.index,
        end: match.index + match[0].length
      }
    });
  }
  
  return refs;
};

export const buildKnowledgeIndex = (files: MarkdownFile[]): KnowledgeIndex => {
  const index: KnowledgeIndex = {
    backlinks: new Map(),
    tags: new Map(),
    wikilinks: new Map()
  };
  
  // æ„å»ºåå‘é“¾æ¥ç´¢å¼•
  files.forEach(file => {
    const links = extractWikiLinks(file.content);
    links.forEach(link => {
      if (!index.backlinks.has(link.target)) {
        index.backlinks.set(link.target, []);
      }
      index.backlinks.get(link.target)!.push(file.id);
    });
  });
  
  return index;
};
```

#### 1.3 WikiLink ç»„ä»¶

**æ–°å»ºæ–‡ä»¶**ï¼š`components/WikiLink.tsx`

```typescript
interface WikiLinkProps {
  target: string;
  alias?: string;
  onClick?: (target: string) => void;
  onHover?: (target: string) => void;
}

export const WikiLink: React.FC<WikiLinkProps> = ({ target, alias, onClick, onHover }) => {
  const [showPreview, setShowPreview] = useState(false);
  
  return (
    <span 
      className="wikilink"
      onClick={() => onClick?.(target)}
      onMouseEnter={() => {
        setShowPreview(true);
        onHover?.(target);
      }}
      onMouseLeave={() => setShowPreview(false)}
    >
      <span className="text-blue-500 hover:underline cursor-pointer">
        {alias || target}
      </span>
      
      {/* æ‚¬åœé¢„è§ˆ */}
      {showPreview && (
        <div className="absolute z-50 w-64 p-2 bg-white border rounded shadow-lg">
          <PagePreview fileName={target} />
        </div>
      )}
    </span>
  );
};
```

#### 1.4 åå‘é“¾æ¥é¢æ¿

**æ–°å»ºæ–‡ä»¶**ï¼š`components/BacklinkPanel.tsx`

```typescript
interface BacklinkPanelProps {
  currentFileId: string;
  backlinks: Backlink[];
}

export const BacklinkPanel: React.FC<BacklinkPanelProps> = ({ currentFileId, backlinks }) => {
  return (
    <div className="backlink-panel p-2 border-l">
      <h3 className="font-bold mb-2">å¼•ç”¨æ­¤é¡µé¢çš„é¡µé¢</h3>
      {backlinks.length === 0 ? (
        <p className="text-gray-500 text-sm">æš‚æ— é¡µé¢å¼•ç”¨æ­¤é¡µé¢</p>
      ) : (
        <ul className="space-y-1">
          {backlinks.map(link => (
            <li key={link.sourceFileId}>
              <button
                className="text-blue-500 hover:underline text-sm"
                onClick={() => openFile(link.sourceFileId)}
              >
                {link.sourceFileName}
              </button>
              {link.context && (
                <p className="text-gray-500 text-xs truncate">{link.context}</p>
              )}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
};
```

---

### Phase 2ï¼šè¯•é¢˜åº“å¼ºåŒ–

#### 2.1 æ‰©å±• Quiz ç±»å‹

**ä¿®æ”¹æ–‡ä»¶**ï¼š`types.ts`

```typescript
// æ·»åŠ é¢˜åº“ç›¸å…³ç±»å‹
export interface QuizQuestion {
  // ... ç°æœ‰å­—æ®µ
  questionBankId?: string;    // æ‰€å±é¢˜åº“
  timesUsed: number;          // ä½¿ç”¨æ¬¡æ•°
  lastUsed: number;           // ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´
  successRate: number;        // æ­£ç¡®ç‡
}

export interface QuestionBank {
  id: string;
  name: string;
  description?: string;
  tags: string[];
  questions: QuizQuestion[];
  createdAt: number;
  updatedAt: number;
  sourceFileIds: string[];    // æ¥æºæ–‡ä»¶
}
```

#### 2.2 é¢˜åº“æœåŠ¡

**æ–°å»ºæ–‡ä»¶**ï¼š`src/services/quiz/questionBankService.ts`

```typescript
export interface QuestionBankStats {
  totalQuestions: number;
  byDifficulty: Record<DifficultyLevel, number>;
  byTags: Record<string, number>;
  averageSuccessRate: number;
}

export const questionBankService = {
  // åˆ›å»ºé¢˜åº“
  createBank(name: string, description?: string): QuestionBank {
    return {
      id: generateId(),
      name,
      description,
      tags: [],
      questions: [],
      createdAt: Date.now(),
      updatedAt: Date.now(),
      sourceFileIds: []
    };
  },
  
  // ä»ç¬”è®°ç”Ÿæˆè¯•é¢˜å¹¶æ·»åŠ åˆ°é¢˜åº“
  async generateAndAddToBank(
    content: string,
    bankId: string,
    config: AIConfig
  ): Promise<QuizQuestion[]> {
    const quiz = await generateQuiz(content, config);
    const questions = quiz.questions.map(q => ({
      ...q,
      questionBankId: bankId,
      timesUsed: 0,
      successRate: 0
    }));
    
    // æ·»åŠ åˆ°é¢˜åº“
    const bank = getBank(bankId);
    bank.questions.push(...questions);
    bank.updatedAt = Date.now();
    
    return questions;
  },
  
  // è·å–é¢˜åº“ç»Ÿè®¡
  getBankStats(bankId: string): QuestionBankStats {
    const bank = getBank(bankId);
    const stats: QuestionBankStats = {
      totalQuestions: bank.questions.length,
      byDifficulty: { easy: 0, medium: 0, hard: 0 },
      byTags: {},
      averageSuccessRate: 0
    };
    
    bank.questions.forEach(q => {
      if (q.difficulty) stats.byDifficulty[q.difficulty]++;
      q.tags?.forEach(tag => {
        stats.byTags[tag] = (stats.byTags[tag] || 0) + 1;
      });
    });
    
    return stats;
  }
};
```

#### 2.3 é¢˜åº“ç®¡ç†ç»„ä»¶

**æ–°å»ºæ–‡ä»¶**ï¼š`components/QuestionBankModal.tsx`

```typescript
interface QuestionBankModalProps {
  isOpen: boolean;
  onClose: () => void;
  banks: QuestionBank[];
  onSelectBank: (bankId: string) => void;
  onCreateBank: (name: string, description?: string) => void;
}

export const QuestionBankModal: React.FC<QuestionBankModalProps> = ({
  isOpen,
  onClose,
  banks,
  onSelectBank,
  onCreateBank
}) => {
  const [newBankName, setNewBankName] = useState('');
  
  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <h2 className="text-xl font-bold mb-4">é¢˜åº“ç®¡ç†</h2>
      
      {/* é¢˜åº“åˆ—è¡¨ */}
      <div className="grid grid-cols-2 gap-4 mb-4">
        {banks.map(bank => (
          <div 
            key={bank.id}
            className="p-3 border rounded cursor-pointer hover:bg-gray-50"
            onClick={() => onSelectBank(bank.id)}
          >
            <h3 className="font-medium">{bank.name}</h3>
            <p className="text-sm text-gray-500">
              {bank.questions.length} é“è¯•é¢˜
            </p>
          </div>
        ))}
      </div>
      
      {/* åˆ›å»ºæ–°é¢˜åº“ */}
      <div className="flex gap-2">
        <input
          type="text"
          value={newBankName}
          onChange={(e) => setNewBankName(e.target.value)}
          placeholder="æ–°é¢˜åº“åç§°"
          className="flex-1 p-2 border rounded"
        />
        <button
          onClick={() => {
            onCreateBank(newBankName);
            setNewBankName('');
          }}
          className="px-4 py-2 bg-blue-500 text-white rounded"
        >
          åˆ›å»º
        </button>
      </div>
    </Modal>
  );
};
```

---

### Phase 3ï¼šæ™ºèƒ½æ ‡ç­¾ç³»ç»Ÿ

#### 3.1 æ‰©å±•æ ‡ç­¾æå–

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/services/knowledgeService.ts`

```typescript
export const extractTags = (content: string): string[] => {
  const regex = /(?:^|\s)(#[a-zA-Z_\u4e00-\u9fa5][\w\-\/\u4e00-\u9fa5]*)/g;
  const tags = new Set<string>();
  let match;
  
  while ((match = regex.exec(content)) !== null) {
    tags.add(match[1].trim());
  }
  
  return Array.from(tags);
};

// AI å»ºè®®æ ‡ç­¾
export const suggestTags = async (content: string, config: AIConfig): Promise<string[]> => {
  const prompt = `åˆ†æä»¥ä¸‹å†…å®¹ï¼Œç”Ÿæˆ 3-5 ä¸ªå±‚æ¬¡åŒ–æ ‡ç­¾ã€‚
  æ ¼å¼: #topic/subtopic
  ç¤ºä¾‹: ["#project/ui", "#dev/react"]
  
  å†…å®¹:
  ${content.substring(0, 1000)}...`;
  
  const res = await generateAIResponse(prompt, config, "You are a taxonomy expert.", true);
  try {
    const jsonStr = res.replace(/```json/g, '').replace(/```/g, '').trim();
    return JSON.parse(jsonStr);
  } catch (e) {
    return [];
  }
};
```

#### 3.2 æ ‡ç­¾ç´¢å¼•

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/services/knowledgeService.ts`

```typescript
export interface KnowledgeIndex {
  tags: Map<string, string[]>;      // tagName -> fileIds
  backlinks: Map<string, string[]>; // pageName -> fileIds
  wikilinks: Map<string, string[]>; // é¡µé¢é“¾æ¥å…³ç³»
}

export const buildKnowledgeIndex = (files: MarkdownFile[]): KnowledgeIndex => {
  const index: KnowledgeIndex = {
    tags: new Map(),
    backlinks: new Map(),
    wikilinks: new Map()
  };
  
  files.forEach(file => {
    // æå–æ ‡ç­¾
    const tags = extractTags(file.content);
    tags.forEach(tag => {
      if (!index.tags.has(tag)) {
        index.tags.set(tag, []);
      }
      index.tags.get(tag)!.push(file.id);
    });
    
    // æå– WikiLink
    const links = extractWikiLinks(file.content);
    links.forEach(link => {
      if (!index.wikilinks.has(file.name)) {
        index.wikilinks.set(file.name, []);
      }
      index.wikilinks.get(file.name)!.push(link.target);
      
      // åå‘é“¾æ¥
      if (!index.backlinks.has(link.target)) {
        index.backlinks.set(link.target, []);
      }
      if (!index.backlinks.get(link.target)!.includes(file.name)) {
        index.backlinks.get(link.target)!.push(file.name);
      }
    });
  });
  
  return index;
};
```

---

### Phase 4ï¼šUI é›†æˆ

#### 4.1 ä¾§è¾¹æ å¢å¼º

**ä¿®æ”¹æ–‡ä»¶**ï¼š`components/Sidebar.tsx`

```typescript
// æ·»åŠ æ ‡ç­¾æµè§ˆå’Œé¢˜åº“å…¥å£
export const Sidebar: React.FC<SidebarProps> = ({ files, onSelectFile }) => {
  const [activeTab, setActiveTab] = useState<'files' | 'tags' | 'banks'>('files');
  
  return (
    <div className="sidebar">
      <Tabs>
        <Tab active={activeTab === 'files'} onClick={() => setActiveTab('files')}>
          æ–‡ä»¶
        </Tab>
        <Tab active={activeTab === 'tags'} onClick={() => setActiveTab('tags')}>
          æ ‡ç­¾
        </Tab>
        <Tab active={activeTab === 'banks'} onClick={() => setActiveTab('banks')}>
          é¢˜åº“
        </Tab>
      </Tabs>
      
      {activeTab === 'files' && <FileTree files={files} onSelect={onSelectFile} />}
      {activeTab === 'tags' && <TagBrowser />}
      {activeTab === 'banks' && <QuestionBankList />}
    </div>
  );
};
```

#### 4.2 é“¾æ¥é¢„è§ˆç»„ä»¶

**æ–°å»ºæ–‡ä»¶**ï¼š`components/LinkPreview.tsx`

```typescript
interface LinkPreviewProps {
  fileName: string;
  position: { x: number; y: number };
}

export const LinkPreview: React.FC<LinkPreviewProps> = ({ fileName, position }) => {
  const [content, setContent] = useState<string | null>(null);
  
  useEffect(() => {
    // å¼‚æ­¥åŠ è½½æ–‡ä»¶å†…å®¹ç”¨äºé¢„è§ˆ
    loadFilePreview(fileName).then(setContent);
  }, [fileName]);
  
  return (
    <div 
      className="link-preview absolute z-50 w-80 p-3 bg-white border rounded shadow-lg"
      style={{ left: position.x, top: position.y }}
    >
      <h4 className="font-medium mb-2">{fileName}</h4>
      {content ? (
        <p className="text-sm text-gray-600 line-clamp-5">
          {content.substring(0, 300)}...
        </p>
      ) : (
        <p className="text-sm text-gray-400">åŠ è½½ä¸­...</p>
      )}
    </div>
  );
};
```

---

### Phase 5ï¼šæµ‹è¯•éªŒè¯

#### 5.1 å•å…ƒæµ‹è¯•

**æ–°å»ºæ–‡ä»¶**ï¼š`test/wiki/wikiLink.test.ts`

```typescript
import { extractWikiLinks, extractBlockReferences } from '../../src/services/wiki/wikiLinkService';

describe('WikiLink Extraction', () => {
  it('should extract basic wikilinks', () => {
    const content = 'See [[Target Page]] for details.';
    const links = extractWikiLinks(content);
    expect(links).toHaveLength(1);
    expect(links[0].target).toBe('Target Page');
  });
  
  it('should extract wikilinks with aliases', () => {
    const content = 'Click [[Target Page|here]] for details.';
    const links = extractWikiLinks(content);
    expect(links).toHaveLength(1);
    expect(links[0].target).toBe('Target Page');
    expect(links[0].alias).toBe('here');
  });
  
  it('should extract block references', () => {
    const content = 'As stated <<Some Page:42>> above...';
    const refs = extractBlockReferences(content);
    expect(refs).toHaveLength(1);
    expect(refs[0].target).toBe('Some Page');
    expect(refs[0].lineNumber).toBe(42);
  });
});
```

---

## ğŸ“ æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/types/wiki.ts` | åŒå‘é“¾æ¥ç±»å‹å®šä¹‰ |
| `src/services/wiki/wikiLinkService.ts` | é“¾æ¥æå–æœåŠ¡ |
| `src/services/quiz/questionBankService.ts` | é¢˜åº“æœåŠ¡ |
| `components/WikiLink.tsx` | WikiLink ç»„ä»¶ |
| `components/BacklinkPanel.tsx` | åå‘é“¾æ¥é¢æ¿ |
| `components/QuestionBankModal.tsx` | é¢˜åº“ç®¡ç†æ¨¡æ€æ¡† |
| `components/LinkPreview.tsx` | é“¾æ¥é¢„è§ˆç»„ä»¶ |
| `test/wiki/wikiLink.test.ts` | é“¾æ¥æå–æµ‹è¯• |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `types.ts` | æ·»åŠ  QuestionBank ç±»å‹ |
| `src/services/knowledgeService.ts` | å¢å¼ºæ ‡ç­¾å’Œé“¾æ¥ç´¢å¼• |
| `components/Sidebar.tsx` | æ·»åŠ æ ‡ç­¾/é¢˜åº“ Tab |
| `components/Editor.tsx` | é›†æˆ WikiLink æ¸²æŸ“ |
| `components/Preview.tsx` | é›†æˆ WikiLink æ¸²æŸ“ |

---

## ğŸ†• è¡¥å……åŠŸèƒ½ (Phase 6-8)

> åŸºäº zhangnote é¡¹ç›®åˆ†æï¼Œä»¥ä¸‹åŠŸèƒ½åœ¨åŸè®¡åˆ’ä¸­é—æ¼ï¼Œç°è¡¥å……åˆ° V1.75 ç»Ÿä¸€è·¯çº¿å›¾

### Phase 6ï¼šé—´éš”é‡å¤æœåŠ¡ (SRS)

> **è¯´æ˜**: TashaStone å·²æœ‰ `StudyPlan` å’Œ `ReviewTask` ç±»å‹å®šä¹‰ (`types.ts`)ï¼Œéœ€å®ç°å®Œæ•´æœåŠ¡
> **å‚è€ƒå®ç°**: `zhangnote/services/srsService.ts`

#### 6.1 æœåŠ¡å®ç°

**æ–°å»ºæ–‡ä»¶**ï¼š`src/services/srs/srsService.ts`

```typescript
import { StudyPlan, ReviewTask, MarkdownFile, MistakeRecord } from '../../types';

const STORAGE_KEY = 'tashastone-srs-plans';

// è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿é—´éš”
const INTERVALS = [
  { label: '5 mins', ms: 5 * 60 * 1000 },
  { label: '30 mins', ms: 30 * 60 * 1000 },
  { label: '12 hours', ms: 12 * 60 * 60 * 1000 },
  { label: '1 day', ms: 24 * 60 * 60 * 1000 },
  { label: '2 days', ms: 2 * 24 * 60 * 60 * 1000 },
  { label: '4 days', ms: 4 * 24 * 60 * 60 * 1000 },
  { label: '7 days', ms: 7 * 24 * 60 * 60 * 1000 },
  { label: '15 days', ms: 15 * 24 * 60 * 60 * 1000 },
];

export const srsService = {
  getStudyPlans(): StudyPlan[] {
    // è·å–æ‰€æœ‰å­¦ä¹ è®¡åˆ’
  },

  createStudyPlanForFile(file: MarkdownFile): StudyPlan {
    // ä¸ºæ–‡ä»¶åˆ›å»ºå­¦ä¹ è®¡åˆ’
  },

  createStudyPlanForMistake(mistake: MistakeRecord): StudyPlan {
    // ä¸ºé”™é¢˜åˆ›å»ºå­¦ä¹ è®¡åˆ’
  },

  markTaskComplete(planId: string, taskId: string): void {
    // æ ‡è®°ä»»åŠ¡å®Œæˆ
  },

  getTaskStatus(task: ReviewTask): 'pending' | 'completed' | 'overdue' | 'future' {
    // è·å–ä»»åŠ¡çŠ¶æ€
  },

  deleteStudyPlan(planId: string): void {
    // åˆ é™¤å­¦ä¹ è®¡åˆ’
  }
};
```

#### 6.2 ç»„ä»¶å®ç°

**æ–°å»ºæ–‡ä»¶**ï¼š`components/StudyPlanPanel.tsx`

```typescript
interface StudyPlanPanelProps {
  plans: StudyPlan[];
  onComplete: (planId: string, taskId: string) => void;
  onDelete: (planId: string) => void;
  onOpenSource: (sourceId: string, sourceType: 'file' | 'mistake') => void;
}

// æ˜¾ç¤ºä»Šæ—¥å¾…å¤ä¹ ã€è¿›è¡Œä¸­ã€å·²å®Œæˆçš„è®¡åˆ’
// è¿›åº¦æ¡æ˜¾ç¤ºå®Œæˆç™¾åˆ†æ¯”
// ä»»åŠ¡çŠ¶æ€é¢œè‰²ï¼špending=é»„, overdue=çº¢, completed=ç»¿, future=ç°
```

### Phase 7ï¼šæ™ºèƒ½æœç´¢ç³»ç»Ÿ

> **è¯´æ˜**: æ‰©å±•ç°æœ‰ RAG æœç´¢ (`ragService.ts`)ï¼Œæ·»åŠ åŒæ¨¡å¼æœç´¢å’Œè¿‡æ»¤è¯­æ³•
> **å‚è€ƒå®ç°**: `zhangnote/components/SearchModal.tsx`, `zhangnote/services/searchService.ts`

#### 7.1 æœç´¢æœåŠ¡

**æ–°å»ºæ–‡ä»¶**ï¼š`src/services/search/searchService.ts`

```typescript
export interface SearchFilter {
  tag?: string;
  type?: 'file' | 'exam';
  ext?: string;
  after?: string;  // ISO date
  before?: string; // ISO date
}

export const parseSearchQuery = (query: string): { text: string; filters: SearchFilter } => {
  // è§£ææœç´¢è¯­æ³•ï¼štag:xxx type:file after:2025-01
  const filters: SearchFilter = {};
  let text = query;

  // tag: è¿‡æ»¤
  const tagMatch = query.match(/tag:(\S+)/);
  if (tagMatch) {
    filters.tag = tagMatch[1];
    text = text.replace(tagMatch[0], '').trim();
  }

  // type: è¿‡æ»¤
  const typeMatch = query.match(/type:(file|exam)/);
  if (typeMatch) {
    filters.type = typeMatch[1] as 'file' | 'exam';
    text = text.replace(typeMatch[0], '').trim();
  }

  // æ—¥æœŸè¿‡æ»¤
  const afterMatch = query.match(/after:(\S+)/);
  const beforeMatch = query.match(/before:(\S+)/);
  // ...

  return { text, filters };
};

export const applyFilters = (results: SearchResult[], filters: SearchFilter): SearchResult[] => {
  // åº”ç”¨è¿‡æ»¤å™¨
};
```

#### 7.2 æœç´¢æ¨¡æ€æ¡†

**æ–°å»ºæ–‡ä»¶**ï¼š`components/SearchModal.tsx`

```typescript
interface SearchModalProps {
  isOpen: boolean;
  onClose: () => void;
  files: MarkdownFile[];
  onSelectFile: (fileId: string) => void;
}

export const SearchModal: React.FC<SearchModalProps> = ({
  isOpen, onClose, files, onSelectFile
}) => {
  const [query, setQuery] = useState('');
  const [mode, setMode] = useState<'instant' | 'semantic'>('instant');
  const [results, setResults] = useState<SearchResult[]>([]);
  const [selectedIndex, setSelectedIndex] = useState(0);

  // é”®ç›˜å¯¼èˆª
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'ArrowDown') setSelectedIndex(i => Math.min(i + 1, results.length - 1));
      if (e.key === 'ArrowUp') setSelectedIndex(i => Math.max(i - 1, 0));
      if (e.key === 'Enter') onSelectFile(results[selectedIndex].fileId);
      if (e.key === 'Escape') onClose();
    };
    // ...
  }, [results, selectedIndex]);

  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      {/* æœç´¢è¾“å…¥æ¡† + æ¨¡å¼åˆ‡æ¢ */}
      {/* å·¦ä¾§ï¼šç»“æœåˆ—è¡¨ */}
      {/* å³ä¾§ï¼šé¢„è§ˆé¢æ¿ */}
    </Modal>
  );
};
```

### Phase 8ï¼šæ™ºèƒ½æ•´ç†

> **å‚è€ƒå®ç°**: `zhangnote/components/SmartOrganizeModal.tsx`

#### 8.1 æ™ºèƒ½æ•´ç†æ¨¡æ€æ¡†

**æ–°å»ºæ–‡ä»¶**ï¼š`components/SmartOrganizeModal.tsx`

```typescript
interface SmartOrganizeModalProps {
  isOpen: boolean;
  onClose: () => void;
  file: MarkdownFile;
  aiConfig: AIConfig;
  onApply: (updates: Partial<MarkdownFile>) => void;
}

export const SmartOrganizeModal: React.FC<SmartOrganizeModalProps> = ({
  isOpen, onClose, file, aiConfig, onApply
}) => {
  const [activeTab, setActiveTab] = useState<'analysis' | 'tags' | 'category' | 'links'>('analysis');
  const [importance, setImportance] = useState<number>(0);
  const [suggestedTags, setSuggestedTags] = useState<string[]>([]);
  const [suggestedCategory, setSuggestedCategory] = useState<string>('');

  // AI åˆ†æ
  useEffect(() => {
    if (isOpen && file) {
      // è°ƒç”¨ AI æœåŠ¡è·å–é‡è¦æ€§è¯„åˆ†ã€æ ‡ç­¾å»ºè®®ã€åˆ†ç±»å»ºè®®
    }
  }, [isOpen, file]);

  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <Tabs value={activeTab} onChange={setActiveTab}>
        <Tab value="analysis">åˆ†æ</Tab>
        <Tab value="tags">æ ‡ç­¾</Tab>
        <Tab value="category">åˆ†ç±»</Tab>
        <Tab value="links">é“¾æ¥</Tab>
      </Tabs>

      {activeTab === 'analysis' && (
        <div>
          <ImportanceBar value={importance} />
          <KeyConceptsList concepts={file.keyConcepts} />
        </div>
      )}

      {/* å…¶ä»–æ ‡ç­¾é¡µ */}
    </Modal>
  );
};
```

#### 8.2 AI æœåŠ¡æ‰©å±•

**ä¿®æ”¹æ–‡ä»¶**ï¼š`services/aiService.ts`

```typescript
// æ–°å¢å‡½æ•°
export const assessImportance = async (content: string, config: AIConfig): Promise<number> => {
  // è¿”å› 1-10 çš„é‡è¦æ€§è¯„åˆ†
};

export const suggestCategory = async (content: string, config: AIConfig): Promise<string> => {
  // è¿”å›å»ºè®®çš„æ–‡ä»¶å¤¹è·¯å¾„
};
```

---

## ğŸ“ è¡¥å……æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶ (Phase 6-8)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/services/srs/srsService.ts` | é—´éš”é‡å¤æœåŠ¡ |
| `components/StudyPlanPanel.tsx` | å­¦ä¹ è®¡åˆ’é¢æ¿ |
| `src/services/search/searchService.ts` | æœç´¢è¿‡æ»¤æœåŠ¡ |
| `components/SearchModal.tsx` | æ™ºèƒ½æœç´¢æ¨¡æ€æ¡† |
| `components/SmartOrganizeModal.tsx` | æ™ºèƒ½æ•´ç†æ¨¡æ€æ¡† |

### ä¿®æ”¹æ–‡ä»¶ (Phase 6-8)

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `components/QuizPanel.tsx` | é”™é¢˜è‡ªåŠ¨åŠ å…¥å¤ä¹ è®¡åˆ’ |
| `components/Sidebar.tsx` | é›†æˆå¤ä¹ å…¥å£ + å³é”®èœå• |
| `services/aiService.ts` | æ·»åŠ  assessImportance, suggestCategory |

---

## â±ï¸ æ—¶é—´ä¼°ç®—

| Phase | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|-------|------|----------|
| Phase 1 | åŒå‘é“¾æ¥ç³»ç»Ÿ | 8 å°æ—¶ |
| Phase 2 | è¯•é¢˜åº“å¼ºåŒ– | 6 å°æ—¶ |
| Phase 3 | æ™ºèƒ½æ ‡ç­¾ç³»ç»Ÿ | 4 å°æ—¶ |
| Phase 4 | UI é›†æˆ | 6 å°æ—¶ |
| Phase 5 | æµ‹è¯•éªŒè¯ | 4 å°æ—¶ |
| **Phase 6** | **é—´éš”é‡å¤æœåŠ¡** | **4 å°æ—¶** |
| **Phase 7** | **æ™ºèƒ½æœç´¢ç³»ç»Ÿ** | **6 å°æ—¶** |
| **Phase 8** | **æ™ºèƒ½æ•´ç†** | **4 å°æ—¶** |
| **æ€»è®¡** | | **42 å°æ—¶** |

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

1. [ ] æ”¯æŒ `[[é¡µé¢æ ‡é¢˜]]` å’Œ `[[æ ‡é¢˜|åˆ«å]]` æ ¼å¼
2. [ ] æ”¯æŒ `<<é¡µé¢:è¡Œå·>>` å—çº§å¼•ç”¨
3. [ ] åå‘é“¾æ¥é¢æ¿æ˜¾ç¤ºæ‰€æœ‰å¼•ç”¨å½“å‰é¡µé¢çš„é¡µé¢
4. [ ] æ‚¬åœé“¾æ¥æ˜¾ç¤ºé¢„è§ˆå†…å®¹
5. [ ] é¢˜åº“å¯ä»¥åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤
6. [ ] AI å¯ä»¥ä»ç¬”è®°å†…å®¹ç”Ÿæˆè¯•é¢˜å¹¶æ·»åŠ åˆ°é¢˜åº“
7. [ ] æ ‡ç­¾å¯ä»¥è‡ªåŠ¨æå–å’Œ AI å»ºè®®
8. [ ] æŒ‰æ ‡ç­¾å¿«é€Ÿç­›é€‰æ–‡ä»¶
9. [ ] **é—´éš”é‡å¤ç³»ç»Ÿæ”¯æŒæ–‡ä»¶å’Œé”™é¢˜å¤ä¹ è®¡åˆ’** ğŸ†•
10. [ ] **æ™ºèƒ½æœç´¢æ”¯æŒè¿‡æ»¤è¯­æ³•å’ŒåŒæ¨¡å¼** ğŸ†•
11. [ ] **æ™ºèƒ½æ•´ç†æ”¯æŒ AI é‡è¦æ€§è¯„åˆ†å’Œåˆ†ç±»å»ºè®®** ğŸ†•

### ä»£ç éªŒæ”¶

1. [ ] TypeScript ä¸¥æ ¼æ¨¡å¼é€šè¿‡
2. [ ] ESLint è§„åˆ™åˆè§„
3. [ ] å•å…ƒæµ‹è¯•è¦†ç›– > 80%
4. [ ] æ„å»ºéªŒè¯é€šè¿‡

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- é¡¹ç›®çŠ¶æ€ï¼š[PROJECT_STATUS.md](../PROJECT_STATUS.md)
- å¾…åŠäº‹é¡¹ï¼š[TODO.md](../TODO.md)
- ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼š[CONTEXT_ENGINEERING.md](./CONTEXT_ENGINEERING.md)
- æ·±åº¦ç ”ç©¶è®¡åˆ’ï¼š[deepresearch-integration-plan.md](./deepresearch-integration-plan.md)

---

## ğŸ“Š ä¸ v1.7 çš„å…³ç³»

| v1.7 å®Œæˆé¡¹ | v1.75 å¢å¼º |
|-------------|------------|
| çŸ¥è¯†å›¾è°± | é›†æˆåŒå‘é“¾æ¥æ˜¾ç¤º |
| æµ‹éªŒç³»ç»Ÿ | å¼ºåŒ–ä¸ºå®Œæ•´é¢˜åº“ |
| æ ‡ç­¾ç³»ç»Ÿ | AI å»ºè®® + ç´¢å¼•ç®¡ç† |
| æ–‡ä»¶ç®¡ç† | æ·»åŠ  WikiLink å¯¼èˆª |

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.75.2 | åˆ›å»ºæ—¶é—´ï¼š2025-12-31 | æœ€åæ›´æ–°ï¼š2025-12-31 | å˜æ›´ï¼šæ·»åŠ  Phase 6-8 é—æ¼åŠŸèƒ½*
